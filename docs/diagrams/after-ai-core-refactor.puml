@startuml Message Flow After ai-core Refactor
title Message Flow: User Message â†’ Model Response (AFTER)
skinparam backgroundColor #FEFEFE
skinparam sequenceMessageAlign center
skinparam sequenceArrowThickness 2
skinparam roundcorner 10

actor User
participant "React Component\n(Chat)" as Chat
participant "useTelliChat\n(Custom Hook)" as Hook
participant "Server Action\n(sendChatMessage)" as Action
participant "@telli/ai-core\n(generateTextStreamWithBilling)" as AiCore
participant "Azure/IONOS\nAPI" as Provider

User -> Chat : Types message & submits
activate Chat

Chat -> Hook : handleSubmit()
activate Hook
note right of Hook
  Simple custom hook
  manages state & streaming
end note

Hook -> Action : sendChatMessage()\n(Server Action)
activate Action

Action -> Action : getUser() + access checks

Action -> AiCore : generateTextStreamWithBilling()
activate AiCore
note right of AiCore
  Single function handles:
  - Model lookup
  - Access control
  - Quota check
  - Streaming
  - Billing callback
end note

AiCore -> AiCore : getTextModelById()
AiCore -> AiCore : hasAccessToModel()
AiCore -> AiCore : isApiKeyOverQuota()

AiCore -> Provider : OpenAI client\n(direct HTTP)
activate Provider

Provider --> AiCore : SSE Stream
deactivate Provider

AiCore --> Action : AsyncGenerator<string>
deactivate AiCore

Action --> Hook : ReadableStream<string>\n(native)
note right of Hook
  Native streams -
  no proprietary format
end note
deactivate Action

Hook -> Hook : readTextStream()
Hook -> Hook : Update messages state
Hook --> Chat : state updates
deactivate Hook

Chat --> User : Shows streaming response
deactivate Chat

note over AiCore
  onComplete callback:
  - billTextGenerationUsage()
  Automatic billing with usage data
end note

@enduml
